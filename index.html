<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>HomeFit Coach — Allenamento a casa</title>
<meta name="theme-color" content="#0a0f16" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

<style>
:root{
  --bg:#0a0f16; --panel:#0f1622; --text:#e8eef6;
  --muted:#9db0c8; --accent:#3b82f6; --danger:#ef4444;
}
*{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
html,body{height:100%; overflow:hidden}
body{margin:0; background:var(--bg); color:#e8eef6; font-family:system-ui,-apple-system,"SF Pro",Inter,Roboto,Arial,sans-serif}
button{appearance:none; -webkit-appearance:none}

/* Layout */
.app{height:100dvh; display:grid; grid-template-rows:1fr auto}

/* SETTINGS (scroll) */
.settings{
  padding:8px 14px 100px;
  background:var(--panel); border-bottom:1px solid #1b2433;
  overflow:auto; -webkit-overflow-scrolling:touch; position:relative; z-index:1;
}
.settingsInner{max-width:720px; margin:0 auto}

/* Brand + HOME */
.brand{padding-top:calc(env(safe-area-inset-top,0px)+8px); margin:0 0 12px}
.homeLink{
  display:inline-flex; align-items:center; gap:6px;
  padding:8px 10px; border-radius:10px; border:1px solid #2a374b;
  color:#d8e6fb; text-decoration:none; font-weight:800; font-size:13px; background:#0e1420;
  margin-bottom:10px;
}
.brandTitle{margin:8px 0 0; font-weight:1000; font-size:clamp(28px,8vw,40px); line-height:1.06; letter-spacing:.02em; color:#eef5ff}
.brandTitle .accent{
  background:linear-gradient(90deg,#22d3ee 0%, #3b82f6 55%, #a855f7 100%);
  -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent
}
.brandSub{margin-top:6px; font-size:12.5px; color:var(--muted)}

.heading{font-size:18px; color:#cfe1ff; font-weight:800; margin-top:8px}
.sub{font-size:13px; color:var(--muted)}
.row{display:grid; gap:10px; margin-top:8px; align-items:start}
.rowGrid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
@media (max-width:400px){ .rowGrid{grid-template-columns:1fr 1fr} }
.label{font-size:13px; color:#c4d2e6}

.chips{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
.chip{
  padding:10px 12px; border-radius:12px; border:1px solid #273449; background:#0e1420; color:#d8e6fb;
  font-size:15px; font-weight:700; cursor:pointer; user-select:none; touch-action:manipulation; pointer-events:auto;
}
.chip.selected{background:var(--accent); border-color:transparent; color:#fff; box-shadow:0 6px 18px rgba(59,130,246,.25)}

/* Start bar FISSA e davanti a tutto */
.startBar{
  position:fixed; left:0; right:0; bottom:0; z-index:9999;
  padding:2px 12px calc(6px + env(safe-area-inset-bottom));
  background:linear-gradient(180deg,rgba(10,16,24,0),rgba(10,16,24,.65));
  display:flex; justify-content:center; align-items:center;
}
.btn{
  width:100%; max-width:520px; height:56px; border:none; border-radius:16px;
  font-size:20px; font-weight:900; color:#fff; background:var(--accent);
  box-shadow:0 8px 18px rgba(59,130,246,.18); cursor:pointer; touch-action:manipulation; pointer-events:auto;
}

/* RUN */
.run{display:none; position:relative; background:#000}
.run.on{display:block}
.stage{position:absolute; inset:0; display:grid; place-items:center}
.topBar{position:absolute; top:calc(8px + env(safe-area-inset-top)); left:0; right:0; display:flex; justify-content:space-between; padding:0 10px}
.badge{font-size:12px; color:#b0c4de; background:rgba(10,16,24,.55); padding:6px 8px; border-radius:10px; border:1px solid rgba(255,255,255,.06)}
.phase{font-size:clamp(12px,4vw,16px); color:#dbe9ff; background:rgba(10,16,24,.6); padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.08)}

.center{ text-align:center; padding:24px 16px; max-width:94vw; }
.exercise{
  font-weight:1000;
  /* il valore iniziale è alto, ma verrà ridotto automaticamente via JS */
  font-size:96px;
  line-height:1.08;
  letter-spacing:.02em;
  margin:.1em 0;
  padding:0 4vw;
  color:#fff;
  text-align:center;
  /* — WRAP sicuro — */
  white-space:normal;
  word-break:break-word;
  overflow-wrap:anywhere;
  text-wrap:balance;
}
.timer{font-size:clamp(14px,3.5vw,22px); color:#e9f3ff; background:rgba(10,16,24,.45); padding:.4em .7em; border-radius:12px; border:1px solid rgba(255,255,255,.06); display:inline-block}
.next{position:absolute; bottom:calc(64px + env(safe-area-inset-bottom)); left:0; right:0; text-align:center; font-size:14px; color:#c7d6ee}
.runBar{
  position:fixed; left:0; right:0; bottom:0; z-index:9999;
  padding:max(8px, env(safe-area-inset-bottom)) 10px calc(12px + env(safe-area-inset-bottom));
  display:flex; gap:10px; justify-content:center;
  background:linear-gradient(180deg,rgba(10,16,24,0),rgba(10,16,24,.65))
}
.bb{flex:1; max-width:280px; padding:14px 16px; border:none; border-radius:14px; font-size:18px; font-weight:800; color:#fff; cursor:pointer; touch-action:manipulation; pointer-events:auto;}
.bb.primary{background:var(--accent)} .bb.danger{background:var(--danger)}

/* disattiva clic temporaneamente */
.pe-none{ pointer-events:none !important; }

/* Flash bordo */
.flash{position:absolute; inset:0; pointer-events:none; box-shadow:inset 0 0 0 0 rgba(255,255,255,0)}
.flash.on{animation:edge 220ms ease-out}
@keyframes edge{0%{box-shadow:inset 0 0 0 6px rgba(255,255,255,.85)}100%{box-shadow:inset 0 0 0 0 rgba(255,255,255,0)}}
</style>
</head>
<body>
<div class="app">

  <!-- SETTINGS -->
  <section id="settings" class="settings">
    <div id="settingsInner" class="settingsInner">
      <div class="brand">
        <a class="homeLink" href="https://cavimat99.github.io/Home-MC/" target="_self" rel="noopener">← Torna a HOME</a>
        <h1 class="brandTitle">HomeFit <span class="accent">Coach</span></h1>
        <div class="brandSub">allenamenti guidati · colori e timer</div>
      </div>

      <div class="heading">Imposta allenamento</div>
      <div class="sub">Scegli parametri e premi Start.</div>

      <div class="row">
        <div class="label">Categoria</div>
        <div class="chips">
          <button class="chip selected" data-group="cat" data-value="total">Total body</button>
          <button class="chip" data-group="cat" data-value="lower">Gambe/Glutei</button>
          <button class="chip" data-group="cat" data-value="core">Core</button>
          <button class="chip" data-group="cat" data-value="upper">Upper</button>
          <button class="chip" data-group="cat" data-value="low">Low impact</button>
        </div>
      </div>

      <div class="rowGrid">
        <div class="row">
          <div class="label">Lavoro (s)</div>
          <div class="chips">
            <button class="chip" data-group="work" data-value="15">15</button>
            <button class="chip" data-group="work" data-value="20">20</button>
            <button class="chip selected" data-group="work" data-value="30">30</button>
            <button class="chip" data-group="work" data-value="45">45</button>
            <button class="chip" data-group="work" data-value="60">60</button>
          </div>
        </div>
        <div class="row">
          <div class="label">Recupero (s)</div>
          <div class="chips">
            <button class="chip" data-group="rest" data-value="10">10</button>
            <button class="chip selected" data-group="rest" data-value="20">20</button>
            <button class="chip" data-group="rest" data-value="30">30</button>
            <button class="chip" data-group="rest" data-value="45">45</button>
            <button class="chip" data-group="rest" data-value="60">60</button>
          </div>
        </div>
      </div>

      <div class="rowGrid">
        <div class="row">
          <div class="label">Round</div>
          <div class="chips">
            <button class="chip" data-group="rounds" data-value="1">1</button>
            <button class="chip" data-group="rounds" data-value="3">3</button>
            <button class="chip selected" data-group="rounds" data-value="5">5</button>
            <button class="chip" data-group="rounds" data-value="8">8</button>
          </div>
        </div>
        <div class="row">
          <div class="label">Countdown</div>
          <div class="chips">
            <button class="chip" data-group="countdown" data-value="0">Off</button>
            <button class="chip selected" data-group="countdown" data-value="3">3</button>
            <button class="chip" data-group="countdown" data-value="5">5</button>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="label">Suono</div>
        <div class="chips">
          <button class="chip selected" data-group="beep" data-value="on">Beep ON</button>
          <button class="chip" data-group="beep" data-value="off">Beep OFF</button>
        </div>
      </div>
    </div>
  </section>

  <!-- START -->
  <div class="startBar">
    <button id="startBtn" class="btn" onclick="window.__start && window.__start()">START</button>
  </div>

  <!-- RUN -->
  <section id="run" class="run">
    <div class="stage" id="stage">
      <div class="flash" id="flash"></div>
      <div class="topBar">
        <div class="badge" id="roundInfo">Round —</div>
        <div class="phase" id="phase">PRONTO</div>
      </div>
      <div class="center">
        <div class="exercise" id="exercise">—</div>
        <div class="timer"><span id="timeLeft">0.0</span> s</div>
      </div>
      <div class="next" id="nextUp"></div>
    </div>
    <div class="runBar pe-none" id="runBar">
      <button id="bbToggle" class="bb primary">Pausa</button>
      <button id="bbStop" class="bb danger">Stop</button>
    </div>
  </section>

</div>

<script>
(()=> {
  const $=id=>document.getElementById(id);
  const qsa=(s,r=document)=>Array.from(r.querySelectorAll(s));

  /* Esercizi */
  const EX = {
    total:["Jumping Jack","Squat","Affondi alternati","Mountain Climber","Push-up (ginocchia se serve)","Plank","Skater","Burpee light","Good Morning a corpo libero","Sit-up"],
    lower:["Squat","Affondi indietro","Ponte Glutei","Sumo Squat","Step laterale","Calf raise","Affondi laterali","Pistol assistito"],
    core:["Plank","Dead Bug","Russian Twist","Crunch","Bicycle Crunch","Plank spalla-spalla","Side Plank dx","Side Plank sx"],
    upper:["Push-up","Pike Push-up","Dips su sedia","Plank to Push","Superman","Rematore elastico/Asciugamano","Aperture scapole a pancia in giù"],
    low:["Marcia sul posto veloce","Squat lento controllato","Good Morning lento","Affondi indietro controllati","Step touch","Ponte Glutei isometria","Calf raise lento","Wall Sit"]
  };

  /* Stato */
  let app = {
    running:false, paused:false,
    workMs:30000, restMs:20000, rounds:5, countdownMs:3000,
    beep:true, cat:'total',
    roundIndex:0, phase:'idle',
    startTs:0, endTs:0, raf:0, pauseTs:0,
    currentEx:'', nextEx:''
  };

  const els = {
    settings: $('settings'),
    run: $('run'),
    stage: $('stage'),
    roundInfo: $('roundInfo'),
    phase: $('phase'),
    exercise: $('exercise'),
    timeLeft: $('timeLeft'),
    nextUp: $('nextUp'),
    runBar: $('runBar'),
    bbToggle: $('bbToggle'),
    bbStop: $('bbStop')
  };

  /* ============ FIT TESTO ESERCIZIO ============ */
  function fitExercise(){
    // misura dopo che il DOM ha disegnato
    requestAnimationFrame(()=>{
      const el = els.exercise;
      const stage = els.stage;
      const timer = document.querySelector('.timer');
      const topBar = document.querySelector('.topBar');
      const next = $('nextUp');

      // font massimo di partenza (px)
      let size = Math.min(96, Math.max(28, Math.floor(window.innerHeight * 0.11)));
      el.style.fontSize = size + 'px';
      el.style.lineHeight = '1.08';

      // spazio disponibile (toglie topBar, timer, "next up" e un margine)
      const availW = stage.clientWidth * 0.9;
      const availH = stage.clientHeight
        - (topBar?.offsetHeight || 0)
        - (timer?.offsetHeight || 0)
        - (next?.offsetHeight || 0)
        - 64; // margine di sicurezza

      // riduci finché entra sia in larghezza che altezza
      let guard = 0;
      while (guard < 50 && size > 22 &&
            (el.scrollWidth > availW || el.scrollHeight > availH)) {
        size -= 2;
        el.style.fontSize = size + 'px';
        guard++;
      }
    });
  }
  function setExerciseText(txt){
    els.exercise.textContent = txt;
    fitExercise();
  }

  /* Chip UI */
  function bindChips(){
    qsa('.chip').forEach(ch=>{
      ch.addEventListener('click', ()=>{
        const g = ch.dataset.group, v = ch.dataset.value;
        qsa(`.chip[data-group="${g}"]`).forEach(b=>b.classList.remove('selected'));
        ch.classList.add('selected');
        if(g==='cat') app.cat=v;
        if(g==='work') app.workMs=+v*1000;
        if(g==='rest') app.restMs=+v*1000;
        if(g==='rounds') app.rounds=+v;
        if(g==='countdown') app.countdownMs=+v*1000;
        if(g==='beep') app.beep=(v==='on');
      }, {passive:true});
    });
  }

  /* Audio (beep) + sblocco iOS */
  let audioCtx=null;
  function ensureCtx(){ try{ audioCtx=audioCtx||new (window.AudioContext||window.webkitAudioContext)(); }catch(e){} return audioCtx; }
  function unlockAudioOnce(){
    try{ const ctx=ensureCtx(); if(!ctx) return; const o=ctx.createOscillator(), g=ctx.createGain(); g.gain.value=0; o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.01);}catch(e){}
  }
  window.addEventListener('touchstart', unlockAudioOnce, {once:true, passive:true});
  window.addEventListener('click', unlockAudioOnce, {once:true});
  window.addEventListener('pointerup', unlockAudioOnce, {once:true});

  function beep(freq=880,dur=0.08,type='sine'){
    if(!app.beep) return;
    const ctx=ensureCtx(); if(!ctx) return;
    try{
      const o=ctx.createOscillator(), g=ctx.createGain();
      o.type=type; o.frequency.value=freq; o.connect(g); g.connect(ctx.destination);
      g.gain.setValueAtTime(0.001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.15, ctx.currentTime+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+dur);
      o.start(); o.stop(ctx.currentTime+dur);
    }catch(e){}
  }

  /* Helpers */
  const fmt=ms=>(Math.ceil(ms/100)/10).toFixed(1);
  const randEx=()=>{ const L=EX[app.cat]||EX.total; return L[Math.floor(Math.random()*L.length)]; };
  function setPhase(p){ app.phase=p; els.phase.textContent=p.toUpperCase(); els.stage.style.background=(p==='rest')?'#06101d':'#0a0f16'; }
  function setTimer(ms){ els.timeLeft.textContent=fmt(ms); }
  function setRound(){ els.roundInfo.textContent=`Round ${app.roundIndex+1} di ${app.rounds}`; }
  function showRun(on){
    const bar=document.querySelector('.startBar');
    if(on){
      $('settings').style.display='none';
      bar.style.display='none';
      $('run').classList.add('on');
      els.runBar.classList.add('pe-none');
      setTimeout(()=>els.runBar.classList.remove('pe-none'), 350);
      fitExercise(); // assicurati che calcoli appena entra in RUN
    } else {
      $('run').classList.remove('on');
      $('settings').style.display='block';
      bar.style.display='flex';
      els.phase.textContent='PRONTO'; setExerciseText('—'); setTimer(0); els.nextUp.textContent=''; els.stage.style.background='#000';
    }
  }

  /* Flow */
  function start(){
    if(app.running) return;
    app.running=true; app.paused=false; app.roundIndex=0;
    app.currentEx=randEx(); app.nextEx=(app.rounds>1)?randEx():'';
    setExerciseText( (app.countdownMs>0)?'PARTENZA':app.currentEx );
    els.nextUp.textContent=(app.countdownMs>0||app.rounds<=1)?'':`Dopo: ${app.nextEx}`;
    setRound(); showRun(true);

    if(app.countdownMs>0){
      setPhase('countdown');
      const t=performance.now(); app.startTs=t; app.endTs=t+app.countdownMs; setTimer(app.countdownMs); beep(660,0.12,'triangle');
    }else{ enterWork(); }
    app.raf=requestAnimationFrame(loop);
  }
  window.__start=start; // fallback onclick

  function enterWork(){
    setPhase('work');
    const t=performance.now(); app.startTs=t; app.endTs=t+app.workMs;
    setExerciseText(app.currentEx);
    els.nextUp.textContent=(app.roundIndex<app.rounds-1&&app.nextEx)?`Dopo: ${app.nextEx}`:'';
    beep(1200,0.06,'square'); setTimeout(()=>beep(900,0.06,'square'),70);
    const f=document.getElementById('flash'); f.classList.remove('on'); void f.offsetWidth; f.classList.add('on');
  }

  function enterRest(){
    setPhase('rest'); setExerciseText('RECUPERO');
    const t=performance.now(); app.startTs=t; app.endTs=t+app.restMs; beep(520,0.1,'sine');
  }

  function nextRound(){
    app.roundIndex++;
    if(app.roundIndex>=app.rounds){ finish(); return; }
    app.currentEx=app.nextEx||randEx(); app.nextEx=(app.roundIndex<app.rounds-1)?randEx():'';
    setRound(); enterWork();
  }

  function finish(){
    setPhase('fine'); setExerciseText('FINE ✅'); els.nextUp.textContent=''; setTimer(0);
    beep(440,0.1,'sine'); setTimeout(()=>beep(660,0.1,'sine'),120); setTimeout(()=>beep(880,0.1,'sine'),240);
    app.running=false; cancelAnimationFrame(app.raf); setTimeout(()=>showRun(false),700);
  }

  function pause(){
    if(!app.running||app.paused) return;
    app.paused=true; app.pauseTs=performance.now(); cancelAnimationFrame(app.raf);
    setExerciseText('PAUSA'); els.nextUp.textContent=''; $('bbToggle').textContent='Riprendi';
  }
  function resume(){
    if(!app.running||app.paused===false) return;
    const now=performance.now(), d=now-app.pauseTs; app.startTs+=d; app.endTs+=d; app.paused=false; $('bbToggle').textContent='Pausa';
    if(app.phase==='work'){ setExerciseText(app.currentEx); els.nextUp.textContent=(app.roundIndex<app.rounds-1&&app.nextEx)?`Dopo: ${app.nextEx}`:''; }
    app.raf=requestAnimationFrame(loop);
  }
  function stop(){ app.running=false; app.paused=false; cancelAnimationFrame(app.raf); showRun(false); }

  function loop(){
    if(!app.running) return;
    if(app.paused){ app.raf=requestAnimationFrame(loop); return; }
    const now=performance.now(), msLeft=Math.max(0, app.endTs-now); setTimer(msLeft);
    if(msLeft<=0){
      if(app.phase==='countdown'){ enterWork(); }
      else if(app.phase==='work'){ if(app.roundIndex>=app.rounds-1){ finish(); } else { app.restMs>0?enterRest():nextRound(); } }
      else if(app.phase==='rest'){ nextRound(); }
    }
    app.raf=requestAnimationFrame(loop);
  }

  /* Eventi */
  bindChips();

  // START: blocca tap fantasma e propagazione
  ['click','touchend','pointerup'].forEach(ev=>{
    $('startBtn').addEventListener(ev, (e)=>{ e.preventDefault(); e.stopPropagation(); start(); }, {passive:false});
  });
  $('bbToggle').addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); app.paused ? resume() : pause(); }, {passive:false});
  $('bbStop').addEventListener('click',  (e)=>{ e.preventDefault(); e.stopPropagation(); stop(); }, {passive:false});

  // rifitta quando cambia orientamento/dimensioni
  window.addEventListener('resize', fitExercise);
  if (window.visualViewport) window.visualViewport.addEventListener('resize', fitExercise);
})();
</script>
</body>
</html>
