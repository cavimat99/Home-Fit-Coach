<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>HomeFit Coach — Allenamento a casa</title>
<meta name="theme-color" content="#0a0f16" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

<style>
:root{
  --bg:#0a0f16; --panel:#0f1622; --text:#e8eef6;
  --muted:#9db0c8; --accent:#3b82f6; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
}
*{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
html,body{height:100%; overflow:hidden}
body{margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,"SF Pro",Inter,Roboto,Arial,sans-serif}
button{appearance:none; -webkit-appearance:none}

/* Layout: settings 1fr + start auto */
.app{height:100dvh; display:grid; grid-template-rows:1fr auto}

/* Brand */
.brand{padding-top:calc(env(safe-area-inset-top,0px)+14px); margin:0 0 12px}
.brandTitle{margin:0; font-weight:1000; font-size:clamp(28px,8vw,40px); line-height:1.06; letter-spacing:.02em; color:#eef5ff}
.brandTitle .accent{
  background:linear-gradient(90deg,#22d3ee 0%, #3b82f6 55%, #a855f7 100%);
  -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent
}
.brandSub{margin-top:6px; font-size:12.5px; color:var(--muted)}

/* Settings */
.settings{padding:8px 14px 10px; background:var(--panel); border-bottom:1px solid #1b2433; overflow:hidden}
.settingsInner{transform-origin:top center}
.heading{font-size:18px; color:#cfe1ff; font-weight:800; margin-top:8px}
.sub{font-size:13px; color:var(--muted)}
.row{display:grid; gap:10px; margin-top:8px; align-items:start}
.rowGrid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
@media (max-width:400px){ .rowGrid{grid-template-columns:1fr 1fr} }
.label{font-size:13px; color:#c4d2e6}
.chips{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
.chip{
  padding:10px 12px; border-radius:12px; border:1px solid #273449; background:#0e1420; color:#d8e6fb;
  font-size:15px; font-weight:700; cursor:pointer; user-select:none
}
.chip.small{font-size:13px; padding:8px 10px}
.chip.selected{background:var(--accent); border-color:transparent; color:#fff; box-shadow:0 6px 18px rgba(59,130,246,.25)}
.settings.compact .chip{padding:8px 10px; font-size:14px}
.settings.compact .chip.small{padding:7px 9px; font-size:12px}

/* Start bar */
.startBar{padding:2px 12px calc(6px + env(safe-area-inset-bottom)); background:linear-gradient(180deg,rgba(10,16,24,0),rgba(10,16,24,.55)); display:flex; justify-content:center; align-items:center}
.btn{width:100%; max-width:520px; height:54px; border:none; border-radius:16px; font-size:20px; font-weight:900; color:#fff; background:var(--accent); box-shadow:0 8px 18px rgba(59,130,246,.18); cursor:pointer}

/* RUN */
.run{display:none; position:relative; background:#000}
.run.on{display:block}
.stage{position:absolute; inset:0; display:grid; place-items:center}
.topBar{position:absolute; top:calc(8px + env(safe-area-inset-top)); left:0; right:0; display:flex; justify-content:space-between; padding:0 10px}
.badge{font-size:12px; color:#b0c4de; background:rgba(10,16,24,.55); padding:6px 8px; border-radius:10px; border:1px solid rgba(255,255,255,.06)}
.phase{font-size:clamp(12px,4vw,16px); color:#dbe9ff; background:rgba(10,16,24,.6); padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.08)}
.center{text-align:center; padding:24px}
.exercise{font-weight:1000; font-size:clamp(32px,10dvh,96px); line-height:1.1; color:#fff; letter-spacing:.02em; margin:.1em 0; padding:0 3vw}
.timer{font-size:clamp(14px,3.5vw,22px); color:#e9f3ff; background:rgba(10,16,24,.45); padding:.4em .7em; border-radius:12px; border:1px solid rgba(255,255,255,.06); display:inline-block}
.next{position:absolute; bottom:calc(64px + env(safe-area-inset-bottom)); left:0; right:0; text-align:center; font-size:14px; color:#c7d6ee}
.runBar{position:fixed; left:0; right:0; bottom:0; padding:max(8px, env(safe-area-inset-bottom)) 10px calc(12px + env(safe-area-inset-bottom)); display:flex; gap:10px; justify-content:center; background:linear-gradient(180deg,rgba(10,16,24,0),rgba(10,16,24,.65))}
.bb{flex:1; max-width:280px; padding:14px 16px; border:none; border-radius:14px; font-size:18px; font-weight:800; color:#fff; cursor:pointer}
.bb.primary{background:var(--accent)} .bb.danger{background:var(--danger)}

/* Flash bordo */
.flash{position:absolute; inset:0; pointer-events:none; box-shadow:inset 0 0 0 0 rgba(255,255,255,0)}
.flash.on{animation:edge 220ms ease-out}
@keyframes edge{0%{box-shadow:inset 0 0 0 6px rgba(255,255,255,.85)}100%{box-shadow:inset 0 0 0 0 rgba(255,255,255,0)}}
</style>
</head>
<body>
<div class="app">

  <!-- SETTINGS -->
  <section id="settings" class="settings">
    <div id="settingsInner" class="settingsInner">
      <div class="brand">
        <h1 class="brandTitle">HomeFit <span class="accent">Coach</span></h1>
        <div class="brandSub">allenamenti guidati · solo voce, colori e timer</div>
      </div>

      <div class="heading">Imposta allenamento</div>
      <div class="sub">Scegli parametri e premi Start.</div>

      <div class="row">
        <div class="label">Categoria</div>
        <div class="chips">
          <button class="chip selected" data-group="cat" data-value="total">Total body</button>
          <button class="chip" data-group="cat" data-value="lower">Gambe/Glutei</button>
          <button class="chip" data-group="cat" data-value="core">Core</button>
          <button class="chip" data-group="cat" data-value="upper">Upper</button>
          <button class="chip" data-group="cat" data-value="low">Low impact</button>
        </div>
      </div>

      <div class="rowGrid">
        <div class="row">
          <div class="label">Lavoro (s)</div>
          <div class="chips">
            <button class="chip" data-group="work" data-value="20">20</button>
            <button class="chip selected" data-group="work" data-value="30">30</button>
            <button class="chip" data-group="work" data-value="45">45</button>
          </div>
        </div>
        <div class="row">
          <div class="label">Recupero (s)</div>
          <div class="chips">
            <button class="chip" data-group="rest" data-value="10">10</button>
            <button class="chip selected" data-group="rest" data-value="20">20</button>
            <button class="chip" data-group="rest" data-value="30">30</button>
          </div>
        </div>
      </div>

      <div class="rowGrid">
        <div class="row">
          <div class="label">Round</div>
          <div class="chips">
            <button class="chip" data-group="rounds" data-value="6">6</button>
            <button class="chip selected" data-group="rounds" data-value="8">8</button>
            <button class="chip" data-group="rounds" data-value="10">10</button>
          </div>
        </div>
        <div class="row">
          <div class="label">Countdown</div>
          <div class="chips">
            <button class="chip" data-group="countdown" data-value="0">Off</button>
            <button class="chip selected" data-group="countdown" data-value="3">3</button>
            <button class="chip" data-group="countdown" data-value="5">5</button>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="label">Voce & Suoni</div>
        <div class="chips">
          <button class="chip small selected" data-group="voice" data-value="on">Voce ON</button>
          <button class="chip small" data-group="voice" data-value="off">Voce OFF</button>
          <button class="chip small selected" data-group="beep" data-value="on">Beep ON</button>
          <button class="chip small" data-group="beep" data-value="off">Beep OFF</button>
        </div>
      </div>
    </div>
  </section>

  <!-- START -->
  <div class="startBar"><button id="startBtn" class="btn">START</button></div>

  <!-- RUN -->
  <section id="run" class="run">
    <div class="stage" id="stage">
      <div class="flash" id="flash"></div>
      <div class="topBar">
        <div class="badge" id="roundInfo">Round —</div>
        <div class="phase" id="phase">PRONTO</div>
      </div>
      <div class="center">
        <div class="exercise" id="exercise">—</div>
        <div class="timer"><span id="timeLeft">0.0</span> s</div>
      </div>
      <div class="next" id="nextUp"></div>
    </div>
    <div class="runBar">
      <button id="bbToggle" class="bb primary">Pausa</button>
      <button id="bbStop" class="bb danger">Stop</button>
    </div>
  </section>

</div>

<script>
(()=> {
  const $=id=>document.getElementById(id);
  const qs=(s,r=document)=>r.querySelector(s);
  const qsa=(s,r=document)=>Array.from(r.querySelectorAll(s));

  /* --- Esercizi (semplici, niente immagini) --- */
  const EX = {
    total: [
      "Jumping Jack","Squat","Affondi alternati","Mountain Climber",
      "Push-up (ginocchia se serve)","Plank","Skater","Burpee light",
      "Good Morning a corpo libero","Sit-up"
    ],
    lower: [
      "Squat","Affondi indietro","Ponte Glutei","Sumo Squat",
      "Step laterale","Calf raise","Affondi laterali","Pistol assistito"
    ],
    core: [
      "Plank","Dead Bug","Russian Twist","Crunch",
      "Bicycle Crunch","Plank spalla-spalla","Side Plank dx","Side Plank sx"
    ],
    upper: [
      "Push-up","Pike Push-up","Dips su sedia","Plank to Push",
      "Superman","Rematore elastico/Asciugamano","Aperture scapole a pancia in giù"
    ],
    low: [
      "Marcia sul posto veloce","Squat lento controllato","Good Morning lento",
      "Affondi indietro controllati","Step touch","Ponte Glutei isometria",
      "Calf raise lento","Wall Sit"
    ]
  };

  /* --- Stato --- */
  let app = {
    running:false, paused:false,
    workMs:30000, restMs:20000, rounds:8, countdownMs:3000,
    voice:true, beep:true, cat:'total',
    roundIndex:0, phase:'idle', // 'countdown'|'work'|'rest'|'fine'
    startTs:0, endTs:0, raf:0, pauseTs:0,
    currentEx:'', nextEx:''
  };

  const els = {
    settings: $('settings'),
    settingsInner: $('settingsInner'),
    run: $('run'),
    stage: $('stage'),
    flash: $('flash'),
    roundInfo: $('roundInfo'),
    phase: $('phase'),
    exercise: $('exercise'),
    timeLeft: $('timeLeft'),
    nextUp: $('nextUp'),
    startBtn: $('startBtn'),
    bbToggle: $('bbToggle'),
    bbStop: $('bbStop')
  };

  /* --- UI chips --- */
  function bindChips(){
    qsa('.chip').forEach(ch=>{
      ch.addEventListener('click', ()=>{
        const group = ch.dataset.group;
        qsa(`.chip[data-group="${group}"]`).forEach(b=>b.classList.remove('selected'));
        ch.classList.add('selected');
        if(group==='cat') app.cat = ch.dataset.value;
        if(group==='work') app.workMs = +ch.dataset.value*1000;
        if(group==='rest') app.restMs = +ch.dataset.value*1000;
        if(group==='rounds') app.rounds = +ch.dataset.value;
        if(group==='countdown') app.countdownMs = +ch.dataset.value*1000;
        if(group==='voice') app.voice = (ch.dataset.value==='on');
        if(group==='beep') app.beep = (ch.dataset.value==='on');
        fitSettings();
      }, {passive:true});
    });
  }

  /* --- Fit: adatta i settings senza scroll --- */
  function fitSettings(){
    const wrap = els.settings, inner = els.settingsInner;
    inner.style.transform='scale(1)'; wrap.classList.remove('compact');
    const avail = wrap.clientHeight;
    const needed = inner.scrollHeight;
    let scale = Math.min(1, avail/needed);
    scale = Math.max(0.6, scale);
    inner.style.transform = `scale(${scale})`;
    if(scale<0.82) wrap.classList.add('compact');
    const used = needed*scale;
    inner.style.marginTop = `${Math.max(0,(avail-used)*0.15)}px`;
  }

  /* --- Beep & Voce --- */
  let audioCtx=null;
  function beep(f=880, d=0.08, type='sine'){
    if(!app.beep) return;
    try{
      audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
      const ctx=audioCtx, o=ctx.createOscillator(), g=ctx.createGain();
      o.type=type; o.frequency.value=f; o.connect(g); g.connect(ctx.destination);
      g.gain.setValueAtTime(0.001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.15, ctx.currentTime+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+d);
      o.start(); o.stop(ctx.currentTime+d);
    }catch(e){}
  }
  function speak(t){
    if(!app.voice) return;
    try{
      const u = new SpeechSynthesisUtterance(t);
      u.lang='it-IT'; u.rate=1; u.pitch=1; u.volume=1;
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    }catch(e){}
  }

  /* --- Helpers --- */
  const fmt=(ms)=> (Math.ceil(ms/100)/10).toFixed(1);
  function randEx(){
    const list = EX[app.cat] || EX.total;
    return list[Math.floor(Math.random()*list.length)];
  }
  function flash(){ els.flash.classList.remove('on'); void els.flash.offsetWidth; els.flash.classList.add('on'); }

  /* --- Fasi --- */
  function setPhase(p){
    app.phase=p;
    els.phase.textContent = p.toUpperCase();
    if(p==='work'){ els.stage.style.background='#0a0f16'; }
    if(p==='rest'){ els.stage.style.background='#06101d'; }
    if(p==='countdown'){ els.stage.style.background='#0a0f16'; }
    if(p==='fine'){ els.stage.style.background='#0a0f16'; }
  }
  function setTimer(ms){ els.timeLeft.textContent = fmt(ms); }
  function setRound(){ els.roundInfo.textContent = `Round ${app.roundIndex+1} di ${app.rounds}`; }

  function start(){
    if(app.running) return;
    app.running = true; app.paused=false; app.roundIndex=0;
    app.currentEx = randEx();
    app.nextEx = randEx();
    els.exercise.textContent = (app.countdownMs>0) ? 'PARTENZA' : app.currentEx;
    els.nextUp.textContent = (app.countdownMs>0) ? '' : `Dopo: ${app.nextEx}`;
    setRound();
    if(app.countdownMs>0){
      setPhase('countdown');
      const t=performance.now();
      app.startTs=t; app.endTs=t+app.countdownMs;
      setTimer(app.countdownMs);
      speak('Pronti');
      beep(660,0.12,'triangle');
    }else{
      enterWork();
    }
    showRun(true);
    app.raf = requestAnimationFrame(loop);
  }

  function enterWork(){
    setPhase('work');
    const t=performance.now();
    app.startTs=t; app.endTs=t+app.workMs;
    els.exercise.textContent = app.currentEx;
    els.nextUp.textContent = `Dopo: ${app.nextEx}`;
    speak(app.currentEx);
    beep(1200,0.06,'square'); setTimeout(()=>beep(900,0.06,'square'),70);
    flash();
  }

  function enterRest(){
    setPhase('rest');
    els.exercise.textContent = 'RECUPERO';
    const t=performance.now();
    app.startTs=t; app.endTs=t+app.restMs;
    speak('Recupero');
    beep(520,0.1,'sine');
  }

  function nextRound(){
    app.roundIndex++;
    if(app.roundIndex >= app.rounds){
      finish();
      return;
    }
    // Avanza esercizi
    app.currentEx = app.nextEx;
    app.nextEx = randEx();
    setRound();
    enterWork();
  }

  function finish(){
    setPhase('fine');
    els.exercise.textContent = 'FINE ✅';
    els.nextUp.textContent = '';
    setTimer(0);
    beep(440,0.1,'sine'); setTimeout(()=>beep(660,0.1,'sine'),120); setTimeout(()=>beep(880,0.1,'sine'),240);
    app.running=false; cancelAnimationFrame(app.raf);
    setTimeout(()=>showRun(false), 700);
  }

  function pause(){
    if(!app.running || app.paused) return;
    app.paused=true; app.pauseTs=performance.now();
    cancelAnimationFrame(app.raf);
    els.exercise.textContent='PAUSA';
    els.nextUp.textContent='';
    els.bbToggle.textContent='Riprendi';
    speak('Pausa');
  }
  function resume(){
    if(!app.running || !app.paused) return;
    const now=performance.now();
    const delta = now - app.pauseTs;
    app.startTs += delta; app.endTs += delta;
    app.paused=false; els.bbToggle.textContent='Pausa';
    // Ripristina subito la scritta corretta se eravamo in lavoro
    if(app.phase==='work'){ els.exercise.textContent = app.currentEx; els.nextUp.textContent = `Dopo: ${app.nextEx}`; }
    app.raf = requestAnimationFrame(loop);
  }
  function stop(){
    app.running=false; app.paused=false; cancelAnimationFrame(app.raf);
    showRun(false);
  }

  function loop(){
    if(!app.running) return;
    if(app.paused){ app.raf = requestAnimationFrame(loop); return; }

    const now=performance.now();
    const msLeft = Math.max(0, app.endTs - now);
    setTimer(msLeft);

    // preannuncio prossimo esercizio a 3s dalla fine del lavoro
    if(app.phase==='work' && msLeft<=3000 && msLeft>2900){
      speak('Prossimo: ' + app.nextEx);
    }

    if(msLeft<=0){
      if(app.phase==='countdown'){ enterWork(); }
      else if(app.phase==='work'){ enterRest(); }
      else if(app.phase==='rest'){ nextRound(); }
    }
    app.raf = requestAnimationFrame(loop);
  }

  function showRun(on){
    if(on){
      els.settings.style.display='none';
      document.querySelector('.startBar').style.display='none';
      els.run.classList.add('on');
    }else{
      els.run.classList.remove('on');
      els.settings.style.display='block';
      document.querySelector('.startBar').style.display='flex';
      fitSettings();
      // reset testi
      els.phase.textContent='PRONTO';
      els.exercise.textContent='—';
      els.timeLeft.textContent='0.0';
      els.nextUp.textContent='';
      els.stage.style.background='#000';
    }
  }

  /* Events */
  bindChips();
  window.addEventListener('load', fitSettings);
  window.addEventListener('resize', fitSettings);
  if(window.visualViewport) window.visualViewport.addEventListener('resize', fitSettings);

  $('startBtn').addEventListener('click', start, {passive:true});
  $('bbToggle').addEventListener('click', ()=> app.paused ? resume() : pause(), {passive:true});
  $('bbStop').addEventListener('click', stop, {passive:true});
})();
</script>
</body>
</html>
